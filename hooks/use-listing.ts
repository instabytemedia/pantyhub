/**
 * CRUD hooks for Listing
 * Auto-generated by crud-scaffolder module
 *
 * These hooks call API routes (not Supabase directly) since they run client-side.
 */

"use client";

import { useState, useEffect, useCallback, useRef } from "react";
import type { Listing, ListingCreate, ListingUpdate } from "@/lib/schemas/listing";

interface Pagination {
  page: number;
  limit: number;
  total: number;
  totalPages: number;
}

interface UseListingsOptions {
  page?: number;
  limit?: number;
  sort?: string;
  order?: "asc" | "desc";
  search?: string;
  enabled?: boolean;
}

interface UseListingsResult {
  data: Listing[];
  pagination: Pagination | null;
  isLoading: boolean;
  error: string | null;
  refetch: () => Promise<void>;
  create: (input: ListingCreate) => Promise<Listing | null>;
  update: (id: string, input: ListingUpdate) => Promise<Listing | null>;
  remove: (id: string) => Promise<boolean>;
}

export function useListings(options: UseListingsOptions = {}): UseListingsResult {
  const { page = 1, limit = 20, sort = "created_at", order = "desc", search, enabled = true } = options;
  const [data, setData] = useState<Listing[]>([]);
  const [pagination, setPagination] = useState<Pagination | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const abortRef = useRef<AbortController | null>(null);

  const fetchData = useCallback(async () => {
    if (!enabled) return;

    // Cancel any in-flight request
    abortRef.current?.abort();
    const controller = new AbortController();
    abortRef.current = controller;

    setIsLoading(true);
    setError(null);
    try {
      const params = new URLSearchParams({
        page: String(page),
        limit: String(limit),
        sort,
        order,
      });
      if (search) params.set("search", search);

      const res = await fetch(`/api/listings?${params}`, {
        signal: controller.signal,
      });
      if (!res.ok) {
        const body = await res.json();
        throw new Error(body.error?.message || "Failed to fetch listings");
      }
      const json = await res.json();
      setData(json.data);
      setPagination(json.pagination);
    } catch (e) {
      if (e instanceof DOMException && e.name === "AbortError") return;
      setError(e instanceof Error ? e.message : "Unknown error");
    } finally {
      setIsLoading(false);
    }
  }, [page, limit, sort, order, search, enabled]);

  useEffect(() => {
    fetchData();
    return () => { abortRef.current?.abort(); };
  }, [fetchData]);

  const create = useCallback(async (input: ListingCreate): Promise<Listing | null> => {
    try {
      const res = await fetch("/api/listings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(input),
      });
      if (!res.ok) {
        const body = await res.json();
        throw new Error(body.error?.message || "Failed to create listing");
      }
      const json = await res.json();
      await fetchData();
      return json.data as Listing;
    } catch (e) {
      setError(e instanceof Error ? e.message : "Unknown error");
      return null;
    }
  }, [fetchData]);

  const update = useCallback(async (id: string, input: ListingUpdate): Promise<Listing | null> => {
    try {
      const res = await fetch(`/api/listings/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(input),
      });
      if (!res.ok) {
        const body = await res.json();
        throw new Error(body.error?.message || "Failed to update listing");
      }
      const json = await res.json();
      await fetchData();
      return json.data as Listing;
    } catch (e) {
      setError(e instanceof Error ? e.message : "Unknown error");
      return null;
    }
  }, [fetchData]);

  const remove = useCallback(async (id: string): Promise<boolean> => {
    try {
      const res = await fetch(`/api/listings/${id}`, { method: "DELETE" });
      if (!res.ok) {
        const body = await res.json();
        throw new Error(body.error?.message || "Failed to delete listing");
      }
      await fetchData();
      return true;
    } catch (e) {
      setError(e instanceof Error ? e.message : "Unknown error");
      return false;
    }
  }, [fetchData]);

  return { data, pagination, isLoading, error, refetch: fetchData, create, update, remove };
}

/** Fetch a single Listing by ID */
export function useListing(id: string | null) {
  const [data, setData] = useState<Listing | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const fetchData = useCallback(async () => {
    if (!id) return;
    setIsLoading(true);
    setError(null);
    try {
      const res = await fetch(`/api/listings/${id}`);
      if (!res.ok) {
        const body = await res.json();
        throw new Error(body.error?.message || "Listing not found");
      }
      const json = await res.json();
      setData(json.data as Listing);
    } catch (e) {
      setError(e instanceof Error ? e.message : "Unknown error");
    } finally {
      setIsLoading(false);
    }
  }, [id]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  return { data, isLoading, error, refetch: fetchData };
}
